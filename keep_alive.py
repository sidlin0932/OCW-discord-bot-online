from flask import Flask, render_template_string
from threading import Thread
import os
from pymongo import MongoClient
from dotenv import load_dotenv
import datetime

load_dotenv()

app = Flask('')

# MongoDB Connection
MONGO_URI = os.getenv("MONGO_URI")
if MONGO_URI:
    client = MongoClient(MONGO_URI)
    db = client["ocw_bot_db"]
    users_col = db["users"]
    reports_col = db["weekly_reports"]
else:
    db = None

# HTML Template
DASHBOARD_HTML = """
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCW Bot Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; color: #555; }
        tr:hover { background-color: #f1f1f1; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.85em; background-color: #e1ecf4; color: #2c3e50; margin-right: 5px; }
        .grade-A { color: #27ae60; font-weight: bold; }
        .grade-F { color: #c0392b; }
        .footer { margin-top: 40px; text-align: center; color: #7f8c8d; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š OCW Bot Dashboard</h1>
        
        {% if error %}
            <div style="color: red; padding: 10px; background: #fee;">{{ error }}</div>
        {% endif %}

        <!-- Latest Weekly Report -->
        <h2>ğŸ“… æœ€æ–°é€±å ± ({{ latest_report.range_str if latest_report else 'å°šç„¡è³‡æ–™' }})</h2>
        {% if latest_report %}
            <table>
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>å§“å</th>
                        <th>åˆ†æ•¸</th>
                        <th>ç­‰ç´š</th>
                        <th>äº’å‹• (ğŸ’¬/ğŸ‘)</th>
                        <th>æˆå°±</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in latest_report.stats %}
                    <tr>
                        <td>
                            {% if user.rank == 1 %}ğŸ¥‡{% elif user.rank == 2 %}ğŸ¥ˆ{% elif user.rank == 3 %}ğŸ¥‰{% else %}{{ user.rank }}{% endif %}
                        </td>
                        <td>{{ user.name }}</td>
                        <td>{{ "%.1f"|format(user.percent_score) }}</td>
                        <td class="grade-{{ user.grade[0] }}">{{ user.grade }}</td>
                        <td>{{ user.message_count }} / {{ user.reaction_count }}</td>
                        <td>
                            {% for badge in user.achievements %}
                                <span class="badge">{{ badge }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>ç›®å‰æ²’æœ‰é€±å ±è³‡æ–™ã€‚</p>
        {% endif %}

        <!-- Bonus Points Leaderboard -->
        <h2>ğŸŒŸ ç¸½åŠ åˆ†æ’è¡Œæ¦œ (Bonus Points)</h2>
        {% if bonus_users %}
            <table>
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>ç›®å‰åŠ åˆ†</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in bonus_users %}
                    <tr>
                        <td>{{ user.name }}</td>
                        <td>{{ user.bonus }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>ç›®å‰æ²’æœ‰åŠ åˆ†è³‡æ–™ã€‚</p>
        {% endif %}

        <div class="footer">
            Generated by OCW Bot v1.2.2 | <a href="/trends">ğŸ“ˆ è¶¨å‹¢åœ–</a> | <a href="/api/stats">API View</a>
        </div>
    </div>
</body>
</html>
"""

# Trends Chart HTML Template
TRENDS_HTML = """
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCW Bot - è¶¨å‹¢åœ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .controls { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .controls label { margin-right: 15px; }
        .chart-wrapper { position: relative; height: 500px; margin-top: 20px; }
        .footer { margin-top: 40px; text-align: center; color: #7f8c8d; font-size: 0.9em; }
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ˆ å­¸ç”Ÿå¾—åˆ†è¶¨å‹¢åœ–</h1>
        
        {% if error %}
            <div style="color: red; padding: 10px; background: #fee;">{{ error }}</div>
        {% else %}
            <div class="controls">
                <strong>ğŸ” ç¯©é¸å­¸ç”Ÿï¼š</strong><br><br>
                <label><input type="checkbox" id="select-all" checked> å…¨é¸/å…¨ä¸é¸</label><br><br>
                <div id="student-filters"></div>
            </div>
            <div class="chart-wrapper">
                <canvas id="trendsChart"></canvas>
            </div>
        {% endif %}

        <div class="footer">
            Generated by OCW Bot v1.2.2 | <a href="/">è¿”å›å„€è¡¨æ¿</a>
        </div>
    </div>

    <script>
        const chartData = {{ chart_data|safe }};
        const ctx = document.getElementById('trendsChart').getContext('2d');
        
        // ç”Ÿæˆé¡è‰²
        const colors = [
            'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 206, 86)',
            'rgb(75, 192, 192)', 'rgb(153, 102, 255)', 'rgb(255, 159, 64)',
            'rgb(199, 199, 199)', 'rgb(83, 102, 147)', 'rgb(144, 238, 144)',
            'rgb(255, 140, 0)', 'rgb(220, 20, 60)', 'rgb(64, 224, 208)'
        ];

        const chart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'å­¸ç”Ÿæ¯é€±å¾—åˆ†è¶¨å‹¢',
                        font: { size: 18 }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'å¾—åˆ†'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'é€±æ¬¡'
                        }
                    }
                }
            }
        });

        // ç”Ÿæˆç¯©é¸å™¨
        const filtersDiv = document.getElementById('student-filters');
        chartData.datasets.forEach((dataset, index) => {
            const label = document.createElement('label');
            label.style.marginRight = '15px';
            label.innerHTML = `<input type="checkbox" class="student-filter" data-index="${index}" checked> ${dataset.label}`;
            filtersDiv.appendChild(label);
        });

        // å…¨é¸/å…¨ä¸é¸
        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.student-filter');
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
                chart.setDatasetVisibility(cb.dataset.index, this.checked);
            });
            chart.update();
        });

        // å€‹åˆ¥ç¯©é¸
        filtersDiv.addEventListener('change', function(e) {
            if (e.target.classList.contains('student-filter')) {
                const index = e.target.dataset.index;
                chart.setDatasetVisibility(index, e.target.checked);
                chart.update();
            }
        });
    </script>
</body>
</html>
"""

@app.route('/')
def dashboard():
    if db is None:
        return render_template_string(DASHBOARD_HTML, error="âŒ è³‡æ–™åº«æœªé€£æ¥ (è«‹æª¢æŸ¥ MONGO_URI)", latest_report=None, bonus_users=None)
    
    # Fetch Latest Report
    latest_report = reports_col.find_one(sort=[("year", -1), ("week", -1)])
    
    # Sort stats in report if exists
    if latest_report and "stats" in latest_report:
        latest_report["stats"] = sorted(latest_report["stats"], key=lambda x: x.get("rank", 999) if x.get("rank", 0) > 0 else 999)

    # Fetch Bonus Users (only those with bonus > 0)
    bonus_users = list(users_col.find({"bonus": {"$gt": 0}}).sort("bonus", -1))

    return render_template_string(DASHBOARD_HTML, latest_report=latest_report, bonus_users=bonus_users)

@app.route('/api/stats')
def api_stats():
    if db is None: return {"error": "No DB"}
    latest = reports_col.find_one(sort=[("year", -1), ("week", -1)], projection={"_id": 0})
    return latest if latest else {"message": "No data"}

@app.route('/trends')
def trends():
    if db is None:
        return render_template_string(TRENDS_HTML, error="âŒ è³‡æ–™åº«æœªé€£æ¥ (è«‹æª¢æŸ¥ MONGO_URI)", chart_data=None)
    
    try:
        # æŸ¥è©¢æ‰€æœ‰é€±å ±æ•¸æ“šä¸¦æ’åº
        all_reports = list(reports_col.find().sort([("year", 1), ("week", 1)]))
        
        if not all_reports:
            return render_template_string(TRENDS_HTML, error="âŒ å°šç„¡æ­·å²æ•¸æ“šï¼Œè«‹ç¨å€™ Bot è‡ªå‹•è¨ˆç®—", chart_data=None)
        
        # æ•´ç†æ•¸æ“š
        labels = []  # Week labels
        students_data = {}  # {student_name: [scores]}
        
        for report in all_reports:
            week_label = f"Week {report['week']}"
            labels.append(week_label)
            
            for user_stat in report.get('stats', []):
                name = user_stat.get('name', 'Unknown')
                score = user_stat.get('percent_score', 0)
                
                if name not in students_data:
                    students_data[name] = []
                students_data[name].append(score)
        
        # ç”Ÿæˆ Chart.js datasets
        colors = [
            'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 206, 86)',
            'rgb(75, 192, 192)', 'rgb(153, 102, 255)', 'rgb(255, 159, 64)',
            'rgb(199, 199, 199)', 'rgb(83, 102, 147)', 'rgb(144, 238, 144)',
            'rgb(255, 140, 0)', 'rgb(220, 20, 60)', 'rgb(64, 224, 208)'
        ]
        
        datasets = []
        for idx, (name, scores) in enumerate(students_data.items()):
            # è£œé½Šç¼ºå¤±é€±æ¬¡çš„æ•¸æ“šç‚º None (Chart.js æœƒè·³é)
            full_scores = scores + [None] * (len(labels) - len(scores))
            
            datasets.append({
                'label': name,
                'data': full_scores,
                'borderColor': colors[idx % len(colors)],
                'backgroundColor': colors[idx % len(colors)].replace('rgb', 'rgba').replace(')', ', 0.1)'),
                'tension': 0.3,
                'fill': False
            })
        
        chart_data = {
            'labels': labels,
            'datasets': datasets
        }
        
        import json
        chart_data_json = json.dumps(chart_data)
        
        return render_template_string(TRENDS_HTML, chart_data=chart_data_json, error=None)
        
    except Exception as e:
        return render_template_string(TRENDS_HTML, error=f"âŒ è¼‰å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}", chart_data=None)

def run():
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 8080)))

def keep_alive():
    t = Thread(target=run)
    t.start()
